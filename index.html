<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ressursfinner â€“ FÃ¦rder kommune</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --farder-blue: #3783C5;
    --farder-blue-dark: #2060a0;
    --farder-blue-light: #dceef8;
    --farder-blue-mid: #4a9ad4;
    --bg: #f5f7f8;
    --surface: #ffffff;
    --border: #dde3e8;
    --green: #1b6b4a;
    --purple: #5a3a8a;
    --orange: #c0601a;
    --text: #1c2833;
    --text-mid: #4a5a65;
    --text-soft: #8a9faa;
    --danger: #b83a3a;
    --radius: 3px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Source Sans 3', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

  /* â”€â”€ White top header matching FÃ¦rder site â”€â”€ */
  .site-header {
    width: 100%;
    background: white;
    border-bottom: 1px solid #dde3e8;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  }
  .site-header-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    align-items: center;
    height: 76px;
    gap: 32px;
  }
  .kommune-logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    flex-shrink: 0;
  }
  /* Shield SVG logo */
  .shield-logo { width: 40px; height: 48px; flex-shrink: 0; }
  .kommune-logo-text { line-height: 1.1; }
  .kommune-logo-name {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--farder-blue);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    display: block;
  }
  .kommune-logo-tagline {
    font-size: 0.65rem;
    color: #7a9aaa;
    font-style: italic;
    display: block;
    margin-top: 1px;
  }

  /* Nav links */
  .site-nav {
    display: flex;
    align-items: center;
    gap: 4px;
    flex: 1;
  }
  .site-nav a {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-mid);
    text-decoration: none;
    padding: 6px 10px;
    border-radius: 3px;
    white-space: nowrap;
    transition: color 0.15s, background 0.15s;
  }
  .site-nav a:hover { color: var(--farder-blue); background: var(--farder-blue-light); }
  .nav-spacer { flex: 1; }
  .nav-search-btn, .nav-menu-btn {
    display: flex; align-items: center; gap: 7px;
    background: var(--farder-blue); color: white;
    border: none; border-radius: 3px; padding: 8px 16px;
    font-family: inherit; font-size: 0.82rem; font-weight: 700;
    cursor: pointer; white-space: nowrap;
  }
  .nav-search-btn { background: white; color: var(--farder-blue); border: 1.5px solid var(--farder-blue); margin-right: 6px; }
  .nav-search-btn svg, .nav-menu-btn svg { width: 14px; height: 14px; }

  /* â”€â”€ Blue section bar below header â”€â”€ */
  .section-bar {
    width: 100%;
    background: var(--farder-blue);
    padding: 0 24px;
  }
  .section-bar-inner {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    height: 40px;
    gap: 8px;
  }
  .section-bar-crumb { color: rgba(255,255,255,0.75); font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
  .section-bar-crumb a { color: rgba(255,255,255,0.85); text-decoration: none; }
  .section-bar-crumb a:hover { color: white; text-decoration: underline; }
  .section-bar-badge { margin-left: auto; background: rgba(255,255,255,0.15); color: white; font-size: 0.62rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 3px 10px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.25); }

  /* â”€â”€ Page title area â”€â”€ */
  .page-title-bar {
    width: 100%;
    background: white;
    border-bottom: 3px solid var(--farder-blue);
    margin-bottom: 28px;
  }
  .page-title-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 24px 24px 20px;
  }
  .page-title-inner h1 { font-size: 1.75rem; font-weight: 700; color: var(--text); margin-bottom: 7px; letter-spacing: -0.01em; }
  .page-title-inner p { font-size: 0.9rem; color: var(--text-mid); line-height: 1.6; max-width: 640px; }

  /* â”€â”€ Main content â”€â”€ */
  .main { width: 100%; max-width: 1100px; padding: 0 24px 60px; display: flex; flex-direction: column; gap: 16px; }

  /* â”€â”€ Cards â”€â”€ */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 22px; }
  .card-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--farder-blue); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

  /* â”€â”€ Inputs â”€â”€ */
  .input-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
  .field { flex: 1; min-width: 160px; }
  .field label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--text-mid); margin-bottom: 5px; }
  .field input, .field select { width: 100%; padding: 9px 12px; border: 1.5px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 0.875rem; background: #f9fafb; color: var(--text); outline: none; transition: border-color 0.15s; }
  .field input:focus, .field select:focus { border-color: var(--farder-blue-mid); background: #fff; box-shadow: 0 0 0 3px var(--farder-blue-light); }
  textarea { width: 100%; border: 1.5px solid var(--border); border-radius: var(--radius); padding: 11px 13px; font-family: inherit; font-size: 0.875rem; line-height: 1.6; background: #f9fafb; color: var(--text); resize: vertical; outline: none; transition: border-color 0.15s; min-height: 130px; }
  textarea:focus { border-color: var(--farder-blue-mid); background: #fff; box-shadow: 0 0 0 3px var(--farder-blue-light); }
  .textarea-hint { font-size: 0.72rem; color: var(--text-soft); margin-top: 5px; line-height: 1.5; }

  /* â”€â”€ Tags â”€â”€ */
  .tag-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .tag { padding: 4px 11px; border-radius: 20px; font-size: 0.71rem; font-weight: 600; border: 1.5px solid; cursor: pointer; transition: all 0.15s; user-select: none; }
  .tag.bio { border-color: var(--green); color: var(--green); }
  .tag.bio.active { background: var(--green); color: white; }
  .tag.psyko { border-color: var(--purple); color: var(--purple); }
  .tag.psyko.active { background: var(--purple); color: white; }
  .tag.sosial { border-color: var(--orange); color: var(--orange); }
  .tag.sosial.active { background: var(--orange); color: white; }
  .tag-hint { font-size: 0.68rem; color: var(--text-soft); margin-top: 6px; }

  /* â”€â”€ Run button â”€â”€ */
  .run-btn { width: 100%; padding: 14px; background: var(--farder-blue); color: white; border: none; border-radius: var(--radius); font-family: inherit; font-size: 0.95rem; font-weight: 700; cursor: pointer; letter-spacing: 0.02em; transition: background 0.15s; display: flex; align-items: center; justify-content: center; gap: 9px; }
  .run-btn:hover { background: var(--farder-blue-dark); }
  .run-btn:disabled { background: #aaa; cursor: not-allowed; }
  .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Output â”€â”€ */
  #output { display: none; }
  #output.visible { display: block; }
  .output-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; gap: 10px; flex-wrap: wrap; }
  .output-header h2 { font-size: 0.95rem; font-weight: 700; color: var(--text); }
  .copy-btn { font-size: 0.78rem; padding: 6px 14px; border: 1.5px solid var(--border); border-radius: var(--radius); background: white; color: var(--text-mid); cursor: pointer; transition: all 0.15s; font-family: inherit; font-weight: 600; }
  .copy-btn:hover { border-color: var(--farder-blue); color: var(--farder-blue); }
  .result-box { background: #f9fafb; border: 1px solid var(--border); border-radius: var(--radius); padding: 22px 24px; font-size: 0.9rem; line-height: 1.85; color: var(--text); white-space: pre-wrap; }
  .section-heading { display: block; font-weight: 700; font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase; margin: 20px 0 9px; padding-bottom: 7px; border-bottom: 2px solid var(--border); }
  .bio-tag { color: var(--green); border-color: var(--green); }
  .psyko-tag { color: var(--purple); }
  .sosial-tag { color: var(--orange); }
  .error-box { background: #fff5f5; border: 1px solid #f5c6c6; border-radius: var(--radius); padding: 12px 14px; font-size: 0.82rem; color: var(--danger); line-height: 1.5; }

  /* â”€â”€ Info strip â”€â”€ */
  .info-strip { display: flex; gap: 10px; align-items: flex-start; background: var(--farder-blue-light); border-left: 4px solid var(--farder-blue); border-radius: var(--radius); padding: 13px 15px; font-size: 0.8rem; color: #1a3a55; line-height: 1.5; }
  .info-strip svg { width: 16px; height: 16px; flex-shrink: 0; margin-top: 1px; color: var(--farder-blue); }

  /* â”€â”€ API key card â”€â”€ */
  .api-key-card { background: #fffcf0; border: 1px solid #e0d080; border-left: 4px solid #c8b000; border-radius: var(--radius); padding: 16px 20px; }
  .api-key-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
  .api-key-row .field { flex: 1; min-width: 240px; }
  .api-key-row input { width: 100%; padding: 9px 12px; border: 1.5px solid #e0d080; border-radius: var(--radius); font-size: 0.82rem; background: #fff; color: var(--text); outline: none; font-family: monospace; }
  .save-key-btn { padding: 9px 20px; background: var(--farder-blue); color: white; border: none; border-radius: var(--radius); font-family: inherit; font-size: 0.82rem; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .save-key-btn:hover { background: var(--farder-blue-dark); }
  .key-hint { font-size: 0.71rem; color: #7a6800; margin-top: 7px; line-height: 1.5; }
  .key-status { font-size: 0.72rem; margin-top: 5px; font-weight: 600; }

  /* â”€â”€ Print â”€â”€ */
  @media print {
    .site-header, .section-bar, .page-title-bar, .api-key-card, .card:not(#output), .info-strip, .run-btn, .footer, .copy-btn { display: none !important; }
    body { background: white; }
    #output { display: block !important; border: none; padding: 0; }
    .result-box { border: none; background: white; padding: 0; font-size: 10pt; line-height: 1.65; }
    .print-header { display: flex !important; }
  }
  .print-header { display: none; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--farder-blue); padding-bottom: 10px; margin-bottom: 14px; }
  .print-header-title { font-size: 14pt; font-weight: 700; color: var(--text); }
  .print-header-sub { font-size: 9pt; color: #555; margin-top: 2px; }
  .print-header-logo { font-size: 11pt; font-weight: 700; color: var(--farder-blue); text-align: right; text-transform: uppercase; letter-spacing: 0.04em; }
  .print-header-logo span { display: block; font-size: 8pt; font-weight: 400; color: #888; font-style: italic; }

  /* â”€â”€ Footer â”€â”€ */
  .footer { width: 100%; background: #1a2e3a; padding: 22px 24px; margin-top: 24px; }
  .footer-inner { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .footer p { color: rgba(255,255,255,0.55); font-size: 0.75rem; }
  .footer a { color: rgba(255,255,255,0.75); text-decoration: none; }
  .footer a:hover { color: white; }
</style>
</head>
<body>

<!-- White site header matching FÃ¦rder kommune -->
<div class="site-header">
  <div class="site-header-inner">
    <a class="kommune-logo" href="https://faerder.kommune.no" target="_blank">
      <!-- Accurate FÃ¦rder kommunevÃ¥pen: Azure shield, argent (white) jib sail -->
      <svg class="shield-logo" viewBox="0 0 200 240" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Heraldic shield shape -->
        <path d="M4 4 H196 V148 C196 196 100 236 100 236 C100 236 4 196 4 148 Z" fill="#3783C5"/>
        <!-- Black outline -->
        <path d="M4 4 H196 V148 C196 196 100 236 100 236 C100 236 4 196 4 148 Z" fill="none" stroke="#1a1a1a" stroke-width="5"/>
        <!-- White jib sail (fokk) - triangular sail shape characteristic of FÃ¦rder -->
        <!-- Mast vertical line -->
        <line x1="80" y1="30" x2="80" y2="200" stroke="white" stroke-width="7" stroke-linecap="round"/>
        <!-- Boom horizontal line at bottom -->
        <line x1="80" y1="200" x2="160" y2="170" stroke="white" stroke-width="7" stroke-linecap="round"/>
        <!-- Sail body: triangle from top of mast to clew -->
        <path d="M80 30 L160 170 L80 200 Z" fill="white" opacity="0.95"/>
        <!-- Sail curve detail (leech curve) -->
        <path d="M80 30 Q155 95 160 170" fill="none" stroke="white" stroke-width="2.5" opacity="0.3"/>
      </svg>
      <div class="kommune-logo-text">
        <span class="kommune-logo-name">FÃ¦rder Kommune</span>
        <span class="kommune-logo-tagline">med vind i seilene</span>
      </div>
    </a>
    <nav class="site-nav">
      <div class="nav-spacer"></div>
      <a href="https://faerder.kommune.no/tjenester/helse-og-omsorg/" target="_blank">Helse og omsorg</a>
      <a href="https://faerder.kommune.no/tjenester/om-farder-kommune/organisasjonen/fardertrappa/" target="_blank">FÃ¦rdertrappa</a>
      <a href="https://faerder.kommune.no/tjenester/om-farder-kommune/kontakt-oss/" target="_blank">Kontakt</a>
      <button class="nav-search-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        SÃ¸k
      </button>
      <button class="nav-menu-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        Meny
      </button>
    </nav>
  </div>
</div>

<!-- Blue section breadcrumb bar -->
<div class="section-bar">
  <div class="section-bar-inner">
    <div class="section-bar-crumb">
      <a href="https://faerder.kommune.no" target="_blank">Forsiden</a> â€º
      <a href="https://faerder.kommune.no/tjenester/helse-og-omsorg/" target="_blank">Helse og omsorg</a> â€º
      <a href="https://faerder.kommune.no/tjenester/om-farder-kommune/organisasjonen/fardertrappa/" target="_blank">FÃ¦rdertrappa</a> â€º
      Ressursfinner
    </div>
    <span class="section-bar-badge">KI-verktÃ¸y</span>
  </div>
</div>

<!-- Page title -->
<div class="page-title-bar">
  <div class="page-title-inner">
    <h1>Ressursfinner â€“ FastlegeverktÃ¸y</h1>
    <p>Skriv inn pasientens behov og historikk â€” KI-en matcher dette mot alle 12 trinn i FÃ¦rdertrappa og lager et praktisk ressursark som kan gis direkte til pasienten.</p>
  </div>
</div>

<div class="main">

  <div class="api-key-card">
    <div class="card-label" style="color:#7a6800; margin-bottom:10px">ðŸ”‘ Anthropic API-nÃ¸kkel</div>
    <div class="api-key-row">
      <div class="field">
        <label style="font-size:0.73rem;font-weight:500;color:var(--text-mid);display:block;margin-bottom:4px">Lim inn din Anthropic API-nÃ¸kkel</label>
        <input type="password" id="apiKeyInput" placeholder="sk-ant-..." autocomplete="off" />
      </div>
      <button class="save-key-btn" onclick="saveKey()">Lagre nÃ¸kkel</button>
    </div>
    <div class="key-hint">
      Hent nÃ¸kkel pÃ¥ <strong>console.anthropic.com</strong> â†’ "API Keys" â†’ "Create Key". NÃ¸kkelen lagres kun i denne nettleseren.
    </div>
    <div class="key-status" id="keyStatus"></div>
  </div>

  <div class="card">
    <div class="card-label">Pasientinformasjon</div>
    <div class="input-row">
      <div class="field">
        <label>Alder</label>
        <input type="text" id="age" placeholder="f.eks. 72" />
      </div>
      <div class="field">
        <label>KjÃ¸nn</label>
        <select id="gender">
          <option value="">â€” ikke angitt â€”</option>
          <option>Mann</option>
          <option>Kvinne</option>
          <option>Ikke-binÃ¦r / annet</option>
        </select>
      </div>
      <div class="field">
        <label>Bosituasjon</label>
        <select id="living">
          <option value="">â€” ikke angitt â€”</option>
          <option>Bor alene</option>
          <option>Bor med partner</option>
          <option>Bor med familie</option>
          <option>Omsorgsbolig / tilrettelagt bolig</option>
        </select>
      </div>
    </div>

    <label class="card-label" style="margin-bottom:8px;display:block">Klinisk sammendrag og behov</label>
    <textarea id="clinicalText" placeholder="Lim inn eller skriv pasienthistorikk her...

Eksempler:
â€¢ 78 Ã¥r gammel kvinne med moderat demens, bor alene. Tiltagende glemsel, noe bekymring for hjemmesikkerheten. Datter strever som pÃ¥rÃ¸rende.
â€¢ 45 Ã¥r gammel mann, nylig jobbtap, depresjon, Ã¸kt alkoholbruk, sosialt isolert etter skilsmisse.
â€¢ 14 Ã¥r gammel med angst og skolevegring. Foreldre bekymret, fastlegehenvisning avvist av BUP."></textarea>
    <div class="textarea-hint">Fritekst fungerer fint â€” diagnoser, funksjonsproblemer, sosial bakgrunn, pÃ¥rÃ¸rendebelastning, boligutfordringer, alt som er relevant.</div>

    <div class="card-label" style="margin-top:16px; margin-bottom:4px">Hurtigvalg behov (valgfritt)</div>
    <div class="tag-row" id="tagRow"></div>
    <div class="tag-hint">Trykk for Ã¥ legge til. Disse legges til i sammendraget.</div>
  </div>

  <div class="info-strip">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <div>Ingen pasientdata lagres eller logges. Resultatet er et forslag â€” bruk alltid ditt eget kliniske skjÃ¸nn. VerktÃ¸yet bruker all informasjon fra FÃ¦rdertrappas 12 trinn (80+ tjenester).</div>
  </div>

  <button class="run-btn" id="runBtn" onclick="runAgent()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
    Generer ressursark for kommunale tjenester
  </button>

  <div class="card" id="output">
    <div class="print-header">
      <div>
        <div class="print-header-title" id="printTitle">Ressursark fra FÃ¦rder kommune</div>
        <div class="print-header-sub">Utskrevet fra FastlegeverktÃ¸y â€“ FÃ¦rdertrappa</div>
      </div>
      <div class="print-header-logo">FÃ¦rder kommune<span>Helse og omsorg Â· 33 39 00 00</span></div>
    </div>
    <div class="output-header">
      <h2 id="outputTitle">Ressursark</h2>
      <div style="display:flex;gap:7px">
        <button class="copy-btn" onclick="copyOutput()">ðŸ“‹ Kopier</button>
        <button class="copy-btn" onclick="window.print()">ðŸ–¨ Skriv ut</button>
      </div>
    </div>
    <div id="resultContent" class="result-box"></div>
    <div id="errorBox" style="display:none" class="error-box"></div>
  </div>

</div>

<script>
// â”€â”€â”€ API Key management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { alert('Lim inn en API-nÃ¸kkel fÃ¸rst.'); return; }
  localStorage.setItem('anthropic_api_key', key);
  document.getElementById('apiKeyInput').value = 'â—'.repeat(20);
  document.getElementById('keyStatus').textContent = 'âœ… NÃ¸kkel er lagret i nettleseren';
  document.getElementById('keyStatus').style.color = '#1b6b4a';
}

function getKey() {
  return localStorage.getItem('anthropic_api_key') || '';
}

// Show status on load
window.addEventListener('DOMContentLoaded', () => {
  const saved = getKey();
  if (saved) {
    document.getElementById('keyStatus').textContent = 'âœ… NÃ¸kkel er lagret i nettleseren';
    document.getElementById('keyStatus').style.color = '#1b6b4a';
    document.getElementById('apiKeyInput').placeholder = 'â—'.repeat(20) + ' (lagret)';
  }
});

const quickTags = [
  { label: 'Demens', cat: 'bio' },
  { label: 'Kroniske smerter', cat: 'bio' },
  { label: 'Fallrisiko', cat: 'bio' },
  { label: 'Rehabilitering etter operasjon', cat: 'bio' },
  { label: 'KOLS / luftveislidelse', cat: 'bio' },
  { label: 'DiabetesoppfÃ¸lging', cat: 'bio' },
  { label: 'Slag / hjerte-kar', cat: 'bio' },
  { label: 'Depresjon', cat: 'psyko' },
  { label: 'Angst', cat: 'psyko' },
  { label: 'Rusbruk', cat: 'psyko' },
  { label: 'Selvskading / krise', cat: 'psyko' },
  { label: 'Psykisk helse barn', cat: 'psyko' },
  { label: 'Sorg / tap', cat: 'psyko' },
  { label: 'Sosial isolasjon', cat: 'sosial' },
  { label: 'PÃ¥rÃ¸rendebelastning', cat: 'sosial' },
  { label: 'Boligutfordringer', cat: 'sosial' },
  { label: 'Ã˜konomiske vansker', cat: 'sosial' },
  { label: 'Flyktning / nyankommet', cat: 'sosial' },
  { label: 'Arbeidsledighet', cat: 'sosial' },
  { label: 'Vold i nÃ¦re relasjoner', cat: 'sosial' },
  { label: 'Enslig forsÃ¸rger', cat: 'sosial' },
];

const activeTags = new Set();
const tagRow = document.getElementById('tagRow');
quickTags.forEach(t => {
  const el = document.createElement('span');
  el.className = `tag ${t.cat}`;
  el.textContent = t.label;
  el.onclick = () => {
    if (activeTags.has(t.label)) { activeTags.delete(t.label); el.classList.remove('active'); }
    else { activeTags.add(t.label); el.classList.add('active'); }
  };
  tagRow.appendChild(el);
});

async function runAgent() {
  const apiKey = getKey();
  if (!apiKey) { alert('Lim inn og lagre en Anthropic API-nÃ¸kkel fÃ¸rst.'); return; }

  const age     = document.getElementById('age').value.trim();
  const gender  = document.getElementById('gender').value;
  const living  = document.getElementById('living').value;
  const clinical = document.getElementById('clinicalText').value.trim();
  const tags    = [...activeTags];

  if (!clinical && tags.length === 0) { alert('Skriv inn et klinisk sammendrag eller velg hurtigvalg.'); return; }

  const btn       = document.getElementById('runBtn');
  const output    = document.getElementById('output');
  const resultBox = document.getElementById('resultContent');
  const errorBox  = document.getElementById('errorBox');

  btn.disabled = true;
  btn.innerHTML = `<div class="spinner"></div> Analyserer pasient og finner tjenesterâ€¦`;
  output.classList.add('visible');
  resultBox.innerHTML = '';
  errorBox.style.display = 'none';

  let patientInfo = '';
  if (age)    patientInfo += `Alder: ${age}. `;
  if (gender) patientInfo += `KjÃ¸nn: ${gender}. `;
  if (living) patientInfo += `Bosituasjon: ${living}. `;
  if (clinical) patientInfo += `\n\nKlinisk sammendrag:\n${clinical}`;
  if (tags.length > 0) patientInfo += `\n\nYtterligere registrerte behov: ${tags.join(', ')}.`;

  const RESOURCES = `
=== FÃ†RDERTRAPPA â€“ KONTAKTINFORMASJON OG TJENESTEBESKRIVELSER ===

TRINN 1 â€“ Attraktiv og inkluderende kommune
- Innbyggertorg: Informasjon og veiledning for alle innbyggere. Tlf: 33 39 00 00. Ã…pent manâ€“fre 09â€“15. Pasienten kan henvende seg selv.
- Fritid FÃ¦rder: Fritids- og ferietilbud for barn og unge med nedsatt funksjonsevne eller fra lavinntektsfamilier. Tlf: 33 39 00 00. Pasienten kan sÃ¸ke selv.
- SjÃ¸lystsenteret: Aktivitetssenter for eldre med sosiale og fysiske aktiviteter. Tlf: 33 39 00 00. Pasienten kan mÃ¸te opp eller ringe selv.
- FÃ¦rder frivilligsentral: BesÃ¸kstjeneste, transporthjelp, fellesskap for ensomme. Tlf: 33 40 90 60. Pasienten kan ringe selv.

TRINN 2 â€“ Helsefremmende hverdagsliv
- Helsestasjon og skolehelsetjeneste (0â€“20 Ã¥r): HelseoppfÃ¸lging, vaksinasjon, samtaler. Tlf: 33 39 00 00. Pasienten/foresatte tar kontakt selv.
- Helsestasjon for ungdom (13â€“24 Ã¥r): Psykisk helse, prevensjon, lavterskel uten timeavtale. SmidsrÃ¸d helsehus. Tlf: 33 39 00 00. Ungdom mÃ¸ter opp uten henvisning.
- FÃ¦rderhuset â€“ Familiesenter: Koordinert stÃ¸tte til barn, unge og familier pÃ¥ ett sted. Tlf: 33 39 00 00. Fastlege kan henvise eller familie tar kontakt selv.
- FÃ¦rder friskliv og mestring: Livsstilskurs â€“ rÃ¸ykeslutt, kosthold, fysisk aktivitet, vektmestring. Tlf: 33 39 00 00. Fastlege kan henvise eller pasienten tar kontakt selv.
- Ergo- og fysioterapitjenesten (voksne): Kartlegging av funksjon, hjelpemidler, tilrettelegging hjemme og pÃ¥ jobb. Tlf: 33 39 00 00. Fastlege henviser direkte.
- Sterk og stÃ¸dig: Fallforebyggende gruppetrening for hjemmeboende eldre. Tlf: 33 39 00 00. Fastlege anbefaler â€“ pasienten melder seg pÃ¥ selv.
- Legevakt Vestfold: Akutt legehjelp utenom Ã¥pningstid. Tlf: 116 117 (hele dÃ¸gnet). Pasienten ringer selv.
- NAV FÃ¦rder: Sosialhjelp, arbeidsavklaring, dagpenger, ufÃ¸retrygd. Tlf: 55 55 33 33 / nav.no. Pasienten tar kontakt selv; fastlege skriver erklÃ¦ring.
- Krisesenteret i Vestfold: Hjelp ved vold i nÃ¦re relasjoner, anonymt og gratis. Tlf: 33 31 11 00 (hele dÃ¸gnet). Pasienten ringer selv.

TRINN 3 â€“ MÃ¥lrettede og forebyggende tjenester
- Kreftkoordinator FÃ¦rder: Koordinerer hjemmeoppfÃ¸lging for kreftpasienter â€“ bindeledd mellom sykehus og kommune. Tlf: 33 39 00 00 (Helseforvaltningen). Fastlege henviser.
- Demenskoordinator / Demensteam: Tidlig kartlegging og stÃ¸tte til pasient og pÃ¥rÃ¸rende ved mistanke om demens. Tlf: 33 39 00 00. Fastlege melder inn.
- Demenspoliklinikk (BjÃ¸nnesÃ¥sen): Spesialisert utredning og diagnostikk av demens. Tlf: 33 39 00 00. Fastlege henviser via Helseforvaltningen.
- Koordinerende enhet / Individuell plan: Koordinerer alle tjenester for pasienter med sammensatte behov â€“ Ã©n kontaktperson. Tlf: 33 39 00 00. Fastlege eller pasient sÃ¸ker om koordinator.
- Psykososialt kriseteam: Akutt psykososial hjelp ved kriser, ulykker og selvmordsrisiko. Tlf: 33 39 00 00 / via legevakt 116 117. Fastlege eller legevakt aktiverer teamet.
- Ruskonsulent FÃ¦rder: Lavterskel rÃ¥dgivning ved problematisk rusmiddelbruk, motivasjonssamtaler. Tlf: 33 39 00 00. Pasienten kan ta kontakt selv, eller fastlege kan henvise.
- FÃ¦rderhuset psykisk helseteam (barn/unge): Psykisk helsehjelp for under 18 Ã¥r med lettereâ€“moderate vansker. Tlf: 33 39 00 00. Fastlege, skole eller foresatte tar kontakt.
- PÃ¥rÃ¸rendeskole / PÃ¥rÃ¸rendestÃ¸tte: Kurs og samtalegrupper for pÃ¥rÃ¸rende til demente, rusmisbrukere eller psykisk syke. Tlf: 33 39 00 00. PÃ¥rÃ¸rende eller pasient tar kontakt selv.
- Frisklivssentral â€“ seniorkurs (Lyst pÃ¥ livet / Takk bare bra): Sosiale mestringskurs for hjemmeboende eldre. Tlf: 33 39 00 00. Fastlege anbefaler â€“ pasienten melder seg pÃ¥.
- Boligveiledning / boligsosialt arbeid: Hjelp til Ã¥ finne og beholde egnet bolig. Tlf: 33 39 00 00. SÃ¸kes via kommunen; fastlege stÃ¸tter med dokumentasjon.
- Vitality-prosjektet: Tidlig innsats for hjemmeboende eldre i risiko for funksjonsfall â€“ kartlegging og tiltak. Tlf: 33 39 00 00. Fastlege melder inn.
- Syn- og hÃ¸rselskontakt / Trygg hjemme: Hjelpemidler for svaksynte/hÃ¸rselshemmede og brannforebygging hjemme. Tlf: 33 39 00 00. Fastlege eller pasienten tar kontakt.

TRINN 4 â€“ Samlokaliserte boliger uten personalbase
- Boligklynger: Tilrettelagte boliger med felles uteomrÃ¥der for sosial stÃ¸tte, uten fast personale. SÃ¸kes via Helseforvaltningen, tlf: 33 39 00 00. Fastlege stÃ¸tter sÃ¸knaden.

TRINN 5 â€“ Meningsfull og inkluderende hverdag
- Dagaktivitetstilbud / Dagsentre: Strukturert dagtilbud for eldre og personer med funksjonsnedsettelse â€“ sosialt fellesskap og stimulering. Tlf: 33 39 00 00 (Helseforvaltningen). Fastlege eller Helseforvaltningen sÃ¸ker for pasienten.
- Arbeidstrening / jobbstÃ¸tte (NAV): Tilbake i jobb â€“ arbeidspraksis, IPS-oppfÃ¸lging, tilrettelegging. Tlf: 55 55 33 33. Fastlege skriver erklÃ¦ring; pasienten kontakter NAV.

TRINN 6 â€“ Kommunalt disponerte boliger
- Kommunale utleieboliger: Tilrettelagte boliger for personer med psykisk lidelse, rus eller funksjonsnedsettelse. SÃ¸kes via Helseforvaltningen, tlf: 33 39 00 00. Fastlege stÃ¸tter sÃ¸knaden.

TRINN 7 â€“ Leve godt i eget hjem
- Hverdagsrehabilitering: Intensiv trening hjemme for Ã¥ gjenvinne daglige ferdigheter etter sykdom. Tlf: 33 39 00 00 (Helseforvaltningen). Fastlege eller sykehus henviser.
- Hjemmehjelp / praktisk bistand: Hjelp til rengjÃ¸ring, innkjÃ¸p og daglige gjÃ¸remÃ¥l. Tlf: 33 39 00 00. Pasienten sÃ¸ker via Helseforvaltningen; fastlege stÃ¸tter.
- Velferdsteknologi: Trygghetsalarm, GPS-sporing, elektronisk medisindispenser. Tlf: 33 39 00 00. Fastlege eller pÃ¥rÃ¸rende tar initiativ; tildeles via kommunen.
- Matombringing: Levering av varm middag til hjemmet. Tlf: 33 39 00 00. Pasienten eller pÃ¥rÃ¸rende sÃ¸ker via kommunen.
- Brukerstyrt personlig assistanse (BPA): Assistent som brukeren selv styrer for selvstendig liv. SÃ¸kes via Helseforvaltningen, tlf: 33 39 00 00. Fastlege stÃ¸tter med dokumentasjon.

TRINN 8 â€“ Helsehjelp til hjemmeboende
- Hjemmesykepleie: Sykepleie hjemme â€“ stell, medisiner, sÃ¥rbehandling, helseovervÃ¥kning. Tlf: 33 39 00 00. Fastlege eller sykehus henviser via Helseforvaltningen.
- Nattjeneste / tilkallingstjeneste: Sykepleier tilgjengelig pÃ¥ natt. Tildeles via Helseforvaltningen, tlf: 33 39 00 00.
- Palliasjon hjemme: Lindrende behandling og pleie i eget hjem ved livets slutt. Fastlege koordinerer via Helseforvaltningen, tlf: 33 39 00 00.

TRINN 9 â€“ Tidsbegrenset opphold
- Korttidsopphold sykehjem: Rehabilitering og opptrening etter sykehusopphold. SÃ¸kes via Helseforvaltningen, tlf: 33 39 00 00. Sykehus eller fastlege sÃ¸ker.
- Avlastningsopphold: Tidsbegrenset opphold for Ã¥ gi pÃ¥rÃ¸rende hvile. Fastlege stÃ¸tter sÃ¸knaden via Helseforvaltningen, tlf: 33 39 00 00.

TRINN 10â€“12 â€“ Boliger med dÃ¸gntjenester, sykehjem og spesialiserte plasser
- Omsorgsleiligheter med alarm: Tilrettelagte boliger med personal tilgjengelig pÃ¥ anrop. Tlf: 33 39 00 00 (Helseforvaltningen).
- Langtidsopphold sykehjem: For de som ikke lenger kan bo hjemme. Tlf: 33 39 00 00. Fastlege bidrar med helseopplysninger.
- Skjermet enhet for demens: Spesialavdeling for alvorlig demens med utfordrende atferd. Tlf: 33 39 00 00.
- Palliativ enhet (SmidsrÃ¸d helsehus): Spesialisert lindrende behandling. Fastlege koordinerer via Helseforvaltningen, tlf: 33 39 00 00.
- Rusinstitusjoner / Psykiatriboliger: Spesialiserte boliger for rus- og psykiatriproblematikk. Tlf: 33 39 00 00 (Helseforvaltningen).

FELLES KONTAKTINFO:
- Helseforvaltningen FÃ¦rder: Tlf: 33 39 00 00 | postmottak@faerder.kommune.no | manâ€“fre 09â€“15
- NAV FÃ¦rder: Tlf: 55 55 33 33 | nav.no
- Legevakt Vestfold: Tlf: 116 117 (hele dÃ¸gnet)
- Krisesenteret i Vestfold: Tlf: 33 31 11 00 (hele dÃ¸gnet)
`;

  const systemPrompt = `Du er et stÃ¸tteverktÃ¸y for fastleger i FÃ¦rder kommune. Din oppgave er Ã¥ lage et praktisk ressursark som KAN SKRIVES UT OG GIES DIREKTE TIL PASIENTEN.

RESSURSDATABASE:
${RESOURCES}

INSTRUKSJONER:
- Velg 4â€“10 av de MEST RELEVANTE tjenestene for denne pasienten. Ikke list opp alt.
- Start med en kort, vennlig innledning adressert til PASIENTEN (2â€“3 setninger, varm tone).
- Organiser svaret i opptil 3 seksjoner med disse EKSAKTE overskriftene (ta bare med seksjoner som er relevante):
  [BIOLOGISK / HELSETJENESTER]
  [PSYKOLOGISK / PSYKISK HELSE]
  [SOSIALT / PRAKTISK STÃ˜TTE]

For HVER tjeneste du nevner, inkluder ALLTID alle disse punktene:
  â€¢ Tjenestenavn (fet)
  â€¢ Hva tjenesten gjÃ¸r (Ã©n setning i enkelt sprÃ¥k som pasienten forstÃ¥r)
  â€¢ Hvem som tar kontakt â€“ enten: "ðŸ“ž Du kan ringe selv:" eller "ðŸ“‹ Fastlegen ordner dette for deg:"
  â€¢ Telefonnummer og/eller nettside
  â€¢ Eventuell Ã¥pningstid eller praktisk info (kort)

Legg deretter til seksjonen [FASTLEGENS HANDLINGSPUNKTER] â€“ marker denne tydelig som intern (kun for legen):
  - Konkrete neste steg legen skal gjÃ¸re
  - Hvilke henvisninger som sendes og til hvem
  - ForeslÃ¥tt oppfÃ¸lgingstidspunkt

Avslutt med seksjonen [VED SPÃ˜RSMÃ…L]:
  FÃ¦rder kommune: 33 39 00 00 | postmottak@faerder.kommune.no | Ã…pent manâ€“fre 09â€“15

VIKTIG:
- Skriv i enkelt, forstÃ¥elig norsk â€“ ingen fagsjargong.
- Telefonnumre skal ALLTID stÃ¥ med.
- Finn IKKE opp kontaktinfo som ikke finnes i databasen.
- Tone i pasientdelen: varm, stÃ¸ttende og oppmuntrende.
- Tone i legedelen: kortfattet og klinisk.`;

  const fullPrompt = `Generer et kommunalt ressursark for fÃ¸lgende pasient:\n\n${patientInfo}`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 2000,
        system: systemPrompt,
        messages: [{ role: 'user', content: fullPrompt }]
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || `API-feil ${response.status}`);

    const text = data.content?.[0]?.text || '';

    const rendered = text
      .replace(/\[BIOLOGISK \/ HELSETJENESTER\]/g, '<span class="section-heading bio-tag">ðŸŸ¢ BIOLOGISK / HELSETJENESTER</span>')
      .replace(/\[PSYKOLOGISK \/ PSYKISK HELSE\]/g, '<span class="section-heading psyko-tag">ðŸŸ£ PSYKOLOGISK / PSYKISK HELSE</span>')
      .replace(/\[SOSIALT \/ PRAKTISK STÃ˜TTE\]/g, '<span class="section-heading sosial-tag">ðŸŸ  SOSIALT / PRAKTISK STÃ˜TTE</span>')
      .replace(/\[FASTLEGENS HANDLINGSPUNKTER\]/g, '<span class="section-heading" style="color:#7a4800;background:#fff8ee;padding:4px 10px;border-radius:3px;border-bottom:2px solid #e0a000">ðŸ“‹ FASTLEGENS HANDLINGSPUNKTER â€“ intern</span>')
      .replace(/\[VED SPÃ˜RSMÃ…L\]/g, '<span class="section-heading" style="color:#1a6496">ðŸ“ž VED SPÃ˜RSMÃ…L</span>');

    resultBox.innerHTML = rendered;

    // Update print header title
    let titleStr = 'Ressursark fra FÃ¦rder kommune';
    if (age || gender) titleStr += ` â€” ${[age ? age + ' Ã¥r' : '', gender].filter(Boolean).join(', ')}`;
    document.getElementById('printTitle').textContent = titleStr;

  } catch (err) {
    errorBox.style.display = 'block';
    errorBox.textContent = `Feil: ${err.message}. Sjekk at API-nÃ¸kkelen er riktig og prÃ¸v igjen.`;
  }

  btn.disabled = false;
  btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg> Generer ressursark for kommunale tjenester`;
  output.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function copyOutput() {
  const text = document.getElementById('resultContent').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = 'âœ… Kopiert!';
    setTimeout(() => btn.textContent = 'ðŸ“‹ Kopier', 2000);
  });
}

document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') runAgent(); });
</script>

</div><!-- /main -->

<div class="footer">
  <div class="footer-inner">
    <p>Â© FÃ¦rder kommune Â· <a href="https://faerder.kommune.no/tjenester/om-farder-kommune/kontakt-oss/">Kontakt oss</a> Â· Tlf: 33 39 00 00 Â· <a href="mailto:postmottak@faerder.kommune.no">postmottak@faerder.kommune.no</a></p>
    <p><a href="https://faerder.kommune.no/tjenester/om-farder-kommune/organisasjonen/fardertrappa/">FÃ¦rdertrappa</a> Â· Internt fastlegeverktÃ¸y</p>
  </div>
</div>

</body>
</html>
