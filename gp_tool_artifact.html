<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F√¶rder Ressursfinner ‚Äì Fastlegeverkt√∏y</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f7f6f2;
    --surface: #ffffff;
    --border: #e2e0d8;
    --accent: #1a5c8a;
    --accent-light: #ddeef8;
    --accent-mid: #3a82b8;
    --green: #1b6b4a;
    --purple: #6b3a9a;
    --orange: #b85220;
    --text: #1c1c2e;
    --text-mid: #4a4a66;
    --text-soft: #8a8aa0;
    --danger: #b83a3a;
    --radius: 10px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 16px 60px;
  }
  .header {
    width: 100%; max-width: 820px;
    padding: 28px 0 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  .header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
  .logo {
    width: 34px; height: 34px; background: var(--accent);
    border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .logo svg { width: 18px; height: 18px; fill: white; }
  .header h1 { font-size: 1.15rem; font-weight: 600; letter-spacing: -0.01em; }
  .header p { font-size: 0.8rem; color: var(--text-soft); margin-left: 46px; line-height: 1.5; }
  .badge {
    font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem;
    background: var(--accent-light); color: var(--accent);
    padding: 2px 7px; border-radius: 4px; letter-spacing: 0.04em;
    font-weight: 500; margin-left: auto; flex-shrink: 0;
  }
  .main { width: 100%; max-width: 820px; display: flex; flex-direction: column; gap: 16px; }
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
  }
  .card-label {
    font-size: 0.68rem; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--text-soft); margin-bottom: 10px;
  }
  .input-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; }
  .field { flex: 1; min-width: 160px; }
  .field label { display: block; font-size: 0.73rem; font-weight: 500; color: var(--text-mid); margin-bottom: 4px; }
  .field input, .field select {
    width: 100%; padding: 8px 11px; border: 1px solid var(--border);
    border-radius: 7px; font-family: inherit; font-size: 0.85rem;
    background: var(--bg); color: var(--text); outline: none; transition: border-color 0.15s;
  }
  .field input:focus, .field select:focus { border-color: var(--accent-mid); background: #fff; }
  textarea {
    width: 100%; border: 1px solid var(--border); border-radius: 7px;
    padding: 11px 13px; font-family: inherit; font-size: 0.85rem;
    line-height: 1.6; background: var(--bg); color: var(--text);
    resize: vertical; outline: none; transition: border-color 0.15s; min-height: 130px;
  }
  textarea:focus { border-color: var(--accent-mid); background: #fff; }
  .textarea-hint { font-size: 0.7rem; color: var(--text-soft); margin-top: 5px; line-height: 1.5; }
  .tag-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .tag {
    padding: 3px 9px; border-radius: 20px; font-size: 0.7rem;
    font-weight: 500; border: 1px solid; cursor: pointer;
    transition: all 0.15s; user-select: none;
  }
  .tag.bio { border-color: var(--green); color: var(--green); background: transparent; }
  .tag.bio.active { background: var(--green); color: white; }
  .tag.psyko { border-color: var(--purple); color: var(--purple); background: transparent; }
  .tag.psyko.active { background: var(--purple); color: white; }
  .tag.sosial { border-color: var(--orange); color: var(--orange); background: transparent; }
  .tag.sosial.active { background: var(--orange); color: white; }
  .tag-hint { font-size: 0.68rem; color: var(--text-soft); margin-top: 6px; }
  .run-btn {
    width: 100%; padding: 12px; background: var(--accent); color: white;
    border: none; border-radius: 8px; font-family: inherit; font-size: 0.88rem;
    font-weight: 600; cursor: pointer; letter-spacing: 0.01em;
    transition: background 0.15s, transform 0.1s;
    display: flex; align-items: center; justify-content: center; gap: 9px;
  }
  .run-btn:hover { background: #1a4f78; }
  .run-btn:active { transform: scale(0.99); }
  .run-btn:disabled { background: #aaa; cursor: not-allowed; }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #output { display: none; }
  #output.visible { display: block; }
  .output-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; gap: 10px; flex-wrap: wrap; }
  .output-header h2 { font-size: 0.95rem; font-weight: 600; }
  .copy-btn {
    font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem;
    padding: 4px 10px; border: 1px solid var(--border); border-radius: 6px;
    background: var(--bg); color: var(--text-mid); cursor: pointer; transition: all 0.15s;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .result-box {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 18px 20px; font-size: 0.85rem; line-height: 1.8;
    color: var(--text); white-space: pre-wrap;
  }
  .section-heading { display: block; font-weight: 700; font-size: 0.75rem; letter-spacing: 0.07em; text-transform: uppercase; margin: 16px 0 7px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
  .bio-tag { color: var(--green); }
  .psyko-tag { color: var(--purple); }
  .sosial-tag { color: var(--orange); }
  .error-box { background: #fff5f5; border: 1px solid #f5c6c6; border-radius: 8px; padding: 12px 14px; font-size: 0.82rem; color: var(--danger); line-height: 1.5; }
  .info-strip {
    display: flex; gap: 8px; align-items: flex-start;
    background: var(--accent-light); border: 1px solid #b8d8ef;
    border-radius: 8px; padding: 11px 13px; font-size: 0.76rem; color: var(--accent); line-height: 1.5;
  }
  .info-strip svg { width: 14px; height: 14px; flex-shrink: 0; margin-top: 1px; }
  .api-key-card {
    background: #fffdf5; border: 1px solid #e8d98a;
    border-radius: var(--radius); padding: 16px 20px;
  }
  .api-key-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
  .api-key-row .field { flex: 1; min-width: 240px; }
  .api-key-row input {
    width: 100%; padding: 8px 11px; border: 1px solid #e8d98a;
    border-radius: 7px; font-family: 'IBM Plex Mono', monospace; font-size: 0.8rem;
    background: #fff; color: var(--text); outline: none;
  }
  .api-key-row input:focus { border-color: #b8a800; }
  .save-key-btn {
    padding: 8px 16px; background: #7a6800; color: white;
    border: none; border-radius: 7px; font-family: inherit;
    font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap;
  }
  .save-key-btn:hover { background: #5a4e00; }
  .key-hint { font-size: 0.7rem; color: #7a6800; margin-top: 6px; line-height: 1.5; }
  .key-status { font-size: 0.72rem; margin-top: 5px; font-weight: 500; }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div class="logo">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H7l5-8v4h4l-5 8z"/></svg>
    </div>
    <h1>F√¶rder Ressursfinner</h1>
    <span class="badge">FASTLEGEVERKT√òY ¬∑ KI-DREVET</span>
  </div>
  <p>Skriv inn pasientsammendrag og behov ‚Äî KI-en matcher dette mot alle 12 trinn i F√¶rdertrappa og lager et praktisk informasjonsark.</p>
</div>

<div class="main">

  <div class="api-key-card">
    <div class="card-label" style="color:#7a6800; margin-bottom:10px">üîë Google Gemini API-n√∏kkel</div>
    <div class="api-key-row">
      <div class="field">
        <label style="font-size:0.73rem;font-weight:500;color:var(--text-mid);display:block;margin-bottom:4px">Lim inn din Gemini API-n√∏kkel</label>
        <input type="password" id="apiKeyInput" placeholder="AIza..." autocomplete="off" />
      </div>
      <button class="save-key-btn" onclick="saveKey()">Lagre n√∏kkel</button>
    </div>
    <div class="key-hint">
      Hent gratis n√∏kkel p√• <strong>aistudio.google.com</strong> ‚Üí "Get API key". N√∏kkelen lagres kun i denne nettleseren.
    </div>
    <div class="key-status" id="keyStatus"></div>
  </div>

  <div class="card">
    <div class="card-label">Pasientinformasjon</div>
    <div class="input-row">
      <div class="field">
        <label>Alder</label>
        <input type="text" id="age" placeholder="f.eks. 72" />
      </div>
      <div class="field">
        <label>Kj√∏nn</label>
        <select id="gender">
          <option value="">‚Äî ikke angitt ‚Äî</option>
          <option>Mann</option>
          <option>Kvinne</option>
          <option>Ikke-bin√¶r / annet</option>
        </select>
      </div>
      <div class="field">
        <label>Bosituasjon</label>
        <select id="living">
          <option value="">‚Äî ikke angitt ‚Äî</option>
          <option>Bor alene</option>
          <option>Bor med partner</option>
          <option>Bor med familie</option>
          <option>Omsorgsbolig / tilrettelagt bolig</option>
        </select>
      </div>
    </div>

    <label class="card-label" style="margin-bottom:8px;display:block">Klinisk sammendrag og behov</label>
    <textarea id="clinicalText" placeholder="Lim inn eller skriv pasienthistorikk her...

Eksempler:
‚Ä¢ 78 √•r gammel kvinne med moderat demens, bor alene. Tiltagende glemsel, noe bekymring for hjemmesikkerheten. Datter strever som p√•r√∏rende.
‚Ä¢ 45 √•r gammel mann, nylig jobbtap, depresjon, √∏kt alkoholbruk, sosialt isolert etter skilsmisse.
‚Ä¢ 14 √•r gammel med angst og skolevegring. Foreldre bekymret, fastlegehenvisning avvist av BUP."></textarea>
    <div class="textarea-hint">Fritekst fungerer fint ‚Äî diagnoser, funksjonsproblemer, sosial bakgrunn, p√•r√∏rendebelastning, boligutfordringer, alt som er relevant.</div>

    <div class="card-label" style="margin-top:16px; margin-bottom:4px">Hurtigvalg behov (valgfritt)</div>
    <div class="tag-row" id="tagRow"></div>
    <div class="tag-hint">Trykk for √• legge til. Disse legges til i sammendraget.</div>
  </div>

  <div class="info-strip">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <div>Ingen pasientdata lagres eller logges. Resultatet er et forslag ‚Äî bruk alltid ditt eget kliniske skj√∏nn. Verkt√∏yet bruker all informasjon fra F√¶rdertrappas 12 trinn (80+ tjenester).</div>
  </div>

  <button class="run-btn" id="runBtn" onclick="runAgent()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
    Generer ressursark for kommunale tjenester
  </button>

  <div class="card" id="output">
    <div class="output-header">
      <h2 id="outputTitle">Ressursark</h2>
      <div style="display:flex;gap:7px">
        <button class="copy-btn" onclick="copyOutput()">üìã Kopier</button>
        <button class="copy-btn" onclick="window.print()">üñ® Skriv ut</button>
      </div>
    </div>
    <div id="resultContent" class="result-box"></div>
    <div id="errorBox" style="display:none" class="error-box"></div>
  </div>

</div>

<script>
const quickTags = [
  { label: 'Demens', cat: 'bio' },
  { label: 'Kroniske smerter', cat: 'bio' },
  { label: 'Fallrisiko', cat: 'bio' },
  { label: 'Rehabilitering etter operasjon', cat: 'bio' },
  { label: 'KOLS / luftveislidelse', cat: 'bio' },
  { label: 'Diabetesoppf√∏lging', cat: 'bio' },
  { label: 'Slag / hjerte-kar', cat: 'bio' },
  { label: 'Depresjon', cat: 'psyko' },
  { label: 'Angst', cat: 'psyko' },
  { label: 'Rusbruk', cat: 'psyko' },
  { label: 'Selvskading / krise', cat: 'psyko' },
  { label: 'Psykisk helse barn', cat: 'psyko' },
  { label: 'Sorg / tap', cat: 'psyko' },
  { label: 'Sosial isolasjon', cat: 'sosial' },
  { label: 'P√•r√∏rendebelastning', cat: 'sosial' },
  { label: 'Boligutfordringer', cat: 'sosial' },
  { label: '√òkonomiske vansker', cat: 'sosial' },
  { label: 'Flyktning / nyankommet', cat: 'sosial' },
  { label: 'Arbeidsledighet', cat: 'sosial' },
  { label: 'Vold i n√¶re relasjoner', cat: 'sosial' },
  { label: 'Enslig fors√∏rger', cat: 'sosial' },
];

const activeTags = new Set();
const tagRow = document.getElementById('tagRow');
quickTags.forEach(t => {
  const el = document.createElement('span');
  el.className = `tag ${t.cat}`;
  el.textContent = t.label;
  el.onclick = () => {
    if (activeTags.has(t.label)) { activeTags.delete(t.label); el.classList.remove('active'); }
    else { activeTags.add(t.label); el.classList.add('active'); }
  };
  tagRow.appendChild(el);
});

const RESOURCES = `
=== F√ÜRDERTRAPPA ‚Äì ALLE 12 TRINN ===

TRINN 1 ‚Äì Attraktiv og inkluderende kommune
- Innbyggertorg: Informasjon og veiledning for alle innbyggere
- Fritid F√¶rder: Fritids- og ferietilbud for barn og unge
- F√¶rder kulturskole: Musikk, kunst og kulturtilbud for alle aldre
- Sj√∏lystsenteret: Aktivitetssenter for eldre
- F√¶rder frivilligsentral: Koordinering av frivillig arbeid (Nyby-app, frivilligb√∏rs)
- Frivillige organisasjoner, idrettslag, velforeninger
- N√∏tter√∏y kulturhus, bibliotek (Tj√∏me og T√∏nsberg)
- Bytteboden SWAP, leksehjelp driftet av pensjonerte l√¶rere
- F√¶rder nasjonalpark, kyststier, helsestier, parker og lekeplasser

TRINN 2 ‚Äì Helsefremmende hverdagsliv
- Helsestasjon og skolehelsetjeneste: Helseoppf√∏lging barn og unge 0‚Äì20 √•r
- Helsestasjon for ungdom: Ungdomsklinikk 13‚Äì24 √•r (psykisk helse, prevensjon)
- F√¶rderhuset: Familiesenter for barn, unge og familier
- Jordmortjeneste / svangerskapsomsorg: Jordmor og svangerskapsoppf√∏lging
- PP-tjeneste (PPT): Pedagogisk-psykologisk tjeneste for barnehage og skole
- F√¶rder friskliv og mestring: Livsstilskurs ‚Äì r√∏ykeslutt, kosthold, fysisk aktivitet
- Ergo- og fysioterapitjenesten voksne: Ergoterapi og fysioterapi for voksne
- Fysioterapi og ergoterapi for barn og unge
- Sterk og st√∏dig: Fallforebyggende gruppetrening for eldre
- Selvhjelpsgrupper psykisk helse (Mental Helse m.fl.)
- Fastlegetjenesten: Fastlege / prim√¶rlege
- Legevakt: Akutt legehjelp utenom √•pningstid
- Krisesenteret i Vestfold: Krisesenter ved vold og trusler ‚Äì interkommunalt
- SLT ‚Äì Rus og kriminalitetsforebyggende arbeid
- Flyktninghelsetjeneste (Smidsr√∏d helsehus)
- Ruskonsulent / r√•dgivning alkoholbruk ungdom
- NAV ‚Äì √òkonomisk r√•d og veiledning
- P√•r√∏rendeskole / p√•r√∏rendest√∏tte
- Mestringskurs psykisk helse, foreldreveiledningskurs
- Introduksjonsprogram for flyktninger

TRINN 3 ‚Äì Helsefremmende og forebyggende tjenester
- God start ‚Äì utvidet helsestasjon: For s√•rbare familier
- Kreftkoordinator: Koordinert hjemmeoppf√∏lging av kreftpasienter
- Demenskoordinator / Demensteam: Tidlig innsats ved demens
- Demenspoliklinikk (Bj√∏nnes√•sen): Poliklinikk for demensutredning
- Koordinerende enhet + Individuell plan: Koordinering av sammensatte tjenester
- Psykososialt kriseteam: Akutt psykososial hjelp ved kriser
- Ruskonsulent: R√•dgiving ved rusproblemer
- BTI-modellen (skole og barnehage): Tidlig tverrfaglig innsats
- F√¶rderhuset psykisk helseteam: Psykisk helsehjelp for barn og unge
- F√¶rderhuset gruppekurs: M√•lrettede kurs for ungdom og foreldre
- Uteteam / Ung Arena: Opps√∏kende ungdomsarbeid, rusfri m√∏teplass
- Familier√•d: Familiekonferanse ‚Äì mobilisering av familienettverket
- Overgrepsmottak: Interkommunalt tilbud ved seksuelle overgrep
- Frisklivssentral: Lyst p√• livet og Takk bare bra (seniorkurs)
- Bo- og boligveiledning, boligtilpasning, boligsosialt arbeid
- Startl√•n, Bost√∏tte, Tilskudd til tilpasning
- Syn/h√∏rselskontakt, brannforebyggende tiltak ‚Äì Trygg hjemme
- Vitality-prosjektet: Tidlig innsats for eldre i risiko
- Koordinator for barn og voksne, Individuell plan

TRINN 4 ‚Äì Samlokaliserte boliger uten personalbase
- Boligklynge med felles uteomr√•der, uten fast personale
- St√∏tte fra naboer og frivillige, tjenester levert til adressen

TRINN 5 ‚Äì Meningsfull og inkluderende hverdag
- Dagaktiviteter / dagsentre
- Arbeidstrening og jobbst√∏tte
- Sosiale deltakelsesprogrammer

TRINN 6 ‚Äì Kommunalt disponerte boliger
- Kommunale utleieboliger for personer med psykisk lidelse, rusavhengighet eller funksjonsnedsettelse

TRINN 7 ‚Äì Leve godt i eget hjem
- Hverdagsrehabilitering: Gjenoppl√¶ring av daglige gj√∏rem√•l hjemme
- Hjemmehjelp / praktisk bistand: Rengj√∏ring, innkj√∏pshjelp
- Velferdsteknologi: Trygghetsalarmer, GPS-sporing, automatisk medisindispenser
- Matombringing: Levering av middag
- Brukerstyrt personlig assistanse (BPA)

TRINN 8 ‚Äì Helsehjelp til hjemmeboende
- Hjemmesykepleie: Stell, medisiner, s√•rbehandling, overv√•kning
- Medisinadministrering hjemme
- Nattjeneste / tilkallingstjeneste
- Palliasjon hjemme

TRINN 9 ‚Äì Tidsbegrenset opphold
- Korttidsopphold p√• sykehjem: Rehabilitering etter sykehusopphold
- Avlastningsopphold: Avlastning for p√•r√∏rende
- Observasjonsopphold

TRINN 10 ‚Äì Boliger med mulighet for d√∏gntjenester
- Omsorgsleiligheter / boliger med alarmsystem
- Personale tilgjengelig p√• anrop, ikke n√∏dvendigvis fast tilstede

TRINN 11 ‚Äì Langtidsopphold i sykehjem og helsehus
- Langtidsopphold sykehjem
- Helsehus (intermedi√¶r omsorg)
- Palliativ enhet
- Skjermet enhet for demens

TRINN 12 ‚Äì Boliger og institusjon ‚Äì spesialiserte plasser
- Rusinstitusjoner
- Psykiatriboliger
- Spesialiserte boliger for funksjonsnedsettelse
- BPA med h√∏yt omsorgsniv√•
`;

// ‚îÄ‚îÄ‚îÄ API Key management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { alert('Lim inn en API-n√∏kkel f√∏rst.'); return; }
  localStorage.setItem('gemini_api_key', key);
  document.getElementById('apiKeyInput').value = '‚óè'.repeat(20);
  document.getElementById('keyStatus').innerHTML = '<span style="color:var(--green)">‚úÖ N√∏kkel lagret!</span>';
}

function getKey() {
  return localStorage.getItem('gemini_api_key') || '';
}

// Load key status on page load
window.addEventListener('load', () => {
  const stored = localStorage.getItem('gemini_api_key');
  if (stored) {
    document.getElementById('apiKeyInput').placeholder = '‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè (n√∏kkel lagret)';
    document.getElementById('keyStatus').innerHTML = '<span style="color:var(--green)">‚úÖ N√∏kkel er lagret i nettleseren</span>';
  }
});

async function runAgent() {
  const apiKey = getKey();
  if (!apiKey) {
    alert('Lim inn din Gemini API-n√∏kkel √∏verst p√• siden og klikk "Lagre n√∏kkel".');
    return;
  }

  const age = document.getElementById('age').value.trim();
  const gender = document.getElementById('gender').value;
  const living = document.getElementById('living').value;
  const clinical = document.getElementById('clinicalText').value.trim();
  const tags = Array.from(activeTags);

  if (!clinical && tags.length === 0) {
    alert('Vennligst skriv inn et klinisk sammendrag eller velg minst ett behovstag.');
    return;
  }

  const btn = document.getElementById('runBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Analyserer pasientbehov‚Ä¶';

  const output = document.getElementById('output');
  const resultBox = document.getElementById('resultContent');
  const errorBox = document.getElementById('errorBox');
  output.classList.add('visible');
  resultBox.textContent = '';
  errorBox.style.display = 'none';

  let patientInfo = '';
  if (age) patientInfo += `Alder: ${age}. `;
  if (gender) patientInfo += `Kj√∏nn: ${gender}. `;
  if (living) patientInfo += `Bosituasjon: ${living}. `;
  if (clinical) patientInfo += `\n\nKlinisk sammendrag:\n${clinical}`;
  if (tags.length > 0) patientInfo += `\n\nYtterligere registrerte behov: ${tags.join(', ')}.`;

  const systemPrompt = `Du er et st√∏tteverkt√∏y for fastleger i F√¶rder kommune i Norge. Du har tilgang til en komplett database over alle kommunale tjenester i F√¶rdertrappa (Trinn 1‚Äì12). Din oppgave er √• lese fastlegens pasientsammendrag og produsere et kortfattet, praktisk informasjonsark med de mest relevante kommunale ressursene for denne spesifikke pasienten.

RESSURSDATABASE:
${RESOURCES}

INSTRUKSJONER:
- Velg 4‚Äì10 av de MEST RELEVANTE tjenestene for denne pasienten. Ikke list opp alt.
- Organiser svaret i opptil 3 seksjoner med disse EKSAKTE overskriftene (inkluder bare en seksjon om den har relevante tjenester):
  [BIOLOGISK / HELSETJENESTER]
  [PSYKOLOGISK / PSYKISK HELSE]
  [SOSIALT / PRAKTISK ST√òTTE]
- For hver tjeneste: navn, √©n setning om hva tjenesten tilbyr, og en kort begrunnelse for HVORFOR den er relevant for denne pasienten.
- Legg til et avsnitt med tittelen [FASTLEGENS HANDLINGSPUNKTER] med 2‚Äì4 konkrete neste steg.
- Klart, profesjonelt norsk. Unng√• fagsjargong. Hold det oversiktlig.
- Avslutt med: "Kontakt: F√¶rder kommune 33 39 00 00 | postmottak@faerder.kommune.no"
- Finn IKKE opp tjenester som ikke finnes i databasen.
- Tone: varm, praktisk og kollegial.`;

  const fullPrompt = systemPrompt + '\n\n---\n\nGenerer et kommunalt ressursark for f√∏lgende pasient:\n\n' + patientInfo;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: fullPrompt }] }],
          generationConfig: { maxOutputTokens: 1200, temperature: 0.3 }
        })
      }
    );

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error?.message || `API-feil ${response.status}`);
    }

    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

    const rendered = text
      .replace(/\[BIOLOGISK \/ HELSETJENESTER\]/g, '<span class="section-heading bio-tag">üü¢ BIOLOGISK / HELSETJENESTER</span>')
      .replace(/\[PSYKOLOGISK \/ PSYKISK HELSE\]/g, '<span class="section-heading psyko-tag">üü£ PSYKOLOGISK / PSYKISK HELSE</span>')
      .replace(/\[SOSIALT \/ PRAKTISK ST√òTTE\]/g, '<span class="section-heading sosial-tag">üü† SOSIALT / PRAKTISK ST√òTTE</span>')
      .replace(/\[FASTLEGENS HANDLINGSPUNKTER\]/g, '<span class="section-heading" style="color:var(--accent)">üìã FASTLEGENS HANDLINGSPUNKTER</span>');

    resultBox.innerHTML = rendered;

    let titleStr = 'Ressursark';
    if (age || gender) titleStr += ` ‚Äî ${[age ? age + ' √•r' : '', gender].filter(Boolean).join(', ')}`;
    document.getElementById('outputTitle').textContent = titleStr;

  } catch (err) {
    errorBox.style.display = 'block';
    errorBox.textContent = `Feil: ${err.message}. Sjekk at API-n√∏kkelen er riktig og pr√∏v igjen.`;
  }

  btn.disabled = false;
  btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg> Generer ressursark for kommunale tjenester`;
  output.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function copyOutput() {
  const text = document.getElementById('resultContent').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = '‚úÖ Kopiert!';
    setTimeout(() => btn.textContent = 'üìã Kopier', 2000);
  });
}

document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') runAgent(); });
</script>
</body>
</html>
